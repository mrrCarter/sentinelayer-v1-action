# Omar Gate — Operations & Release Runbook

This runbook covers incident response, release engineering, CI/CD pipeline operations, and day-to-day maintenance for Omar Gate (SentinelLayer v1 Action).

---

## Table of Contents

1. [Fast Triage](#fast-triage)
2. [Exit Codes](#exit-codes)
3. [CI/CD Pipeline Architecture](#cicd-pipeline-architecture)
4. [Artifact Inventory](#artifact-inventory)
5. [Common Scenarios](#common-scenarios)
6. [Release Process](#release-process)
7. [Dependency & Supply Chain Management](#dependency--supply-chain-management)
8. [LLM CLI Version Management](#llm-cli-version-management)
9. [Secret Rotation](#secret-rotation)
10. [False Positive Handling](#false-positive-handling)
11. [Rollback Procedures](#rollback-procedures)
12. [Monitoring & Observability](#monitoring--observability)
13. [Security & Privacy](#security--privacy)

---

## Fast Triage

1. Identify the workflow run and the failing step.
2. Record the action exit code (see [Exit Codes](#exit-codes)).
3. Open the PR comment and the GitHub Check Run named `Omar Gate` (if enabled).
4. Locate run artifacts under `.sentinelayer/runs/<run_id>/` (or uploaded job artifacts).
5. Check `REVIEW_BRIEF.md` for a prioritized summary; `AUDIT_REPORT.md` for full details.
6. Decide the response: fix code, approve cost, adjust configuration, or enforce fork policy.

---

## Exit Codes

| Code | Meaning | Response |
|---:|---|---|
| `0` | Passed | No action required. |
| `1` | Blocked by severity gate | Fix blocking findings or adjust `severity_gate` per policy. |
| `2` | Configuration/context error | Fix missing/invalid inputs or missing GitHub context. |
| `12` | Fork blocked | Use fork-safe workflow patterns or skip fork PRs. |
| `13` | Approval required | Add approval label, re-run via approved trigger, or raise the threshold. |

**Note:** On dedupe or cooldown, the action short-circuits and mirrors the most recent `Omar Gate` check run result for the same PR head SHA. It exits `0`/`1`/`13` based on that prior result — not a failure code.

---

## CI/CD Pipeline Architecture

Omar Gate's CI runs as three parallel jobs inside `security-review.yml`:

```
┌─────────────────────┐  ┌──────────────────────┐
│  quality-gates      │  │  secret-scanning     │
│  (lint + tests)     │  │  (gitleaks)          │
└────────┬────────────┘  └──────────┬───────────┘
         │                          │
         └─────────┬────────────────┘
                   ▼
         ┌─────────────────┐
         │  omar-review    │
         │  (LLM CLIs +    │
         │   Omar Gate)    │
         └─────────────────┘
```

### Job 1: Quality Gates

- **Trigger:** All PRs + push to `main`.
- **Steps:** Checkout → Python 3.11 setup → Install from `requirements.lock.txt` with `--require-hashes` → Lint (`ruff`) → Type check (`mypy`) → Unit + integration tests (`pytest`).
- **Lockfile:** `requirements.lock.txt` is generated by `pip-compile --generate-hashes` for reproducible, tamper-evident installs.

### Job 2: Secret Scanning

- **Tool:** Gitleaks v8.24.2, downloaded with SHA-256 hash verification.
- **Scope:** Full working tree (`--no-git` flag scans files, not git history).
- **Allowlist:** `.gitleaks.toml` excludes `tests/` and `README.md` (test fixtures contain deliberate dummy secrets).
- **Output:** `gitleaks-report.json` uploaded as artifact on every run.

### Job 3: Omar Review

- **Depends on:** `quality-gates` and `secret-scanning` must both pass.
- **Steps:**
  1. Checkout + Python 3.11 + Node 20 setup
  2. Install Python deps from lockfile
  3. Install LLM CLIs at pinned versions (Codex, Claude Code, Gemini CLI) with npm caching
  4. Verify CLI binaries exist and print versions
  5. Run `python -m omargate.main` (host runner execution)
  6. Publish codebase snapshot to GitHub Step Summary
  7. Upload all run artifacts

### Standalone Quality Gates Workflow

`quality-gates.yml` runs on all PRs and push to `main`. Adds `mypy` type checking on critical modules beyond what `security-review.yml` runs. This is the fast-feedback loop for developers.

---

## Artifact Inventory

Default run directory: `.sentinelayer/runs/<run_id>/`

| Artifact | Format | Purpose |
|---|---|---|
| `FINDINGS.jsonl` | NDJSON | Machine-readable findings (all severities) |
| `REVIEW_BRIEF.md` | Markdown | Reviewer summary with priority table |
| `AUDIT_REPORT.md` | Markdown | Full detailed report |
| `PACK_SUMMARY.json` | JSON | Counts, checksums, run metadata |
| `CODEBASE_INGEST_SUMMARY.md` | Markdown | Deterministic snapshot: LOC, languages, god components |
| `CODEBASE_INGEST_SUMMARY.json` | JSON | Same snapshot, machine-readable |
| `CODEBASE_INGEST.md` | Markdown | Bounded source index |
| `CODEBASE_INGEST.json` | JSON | Full ingest payload + file inventory |
| `ARTIFACT_MANIFEST.json` | JSON | SHA-256 hashes of all artifacts |

### Artifact Integrity

`PACK_SUMMARY.json` contains a SHA-256 hash of `FINDINGS.jsonl`. The gate validates this checksum before evaluating findings. If artifacts are tampered with, the gate fails closed.

### Uploading Artifacts

```yaml
- name: Upload Omar Gate artifacts
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: sentinelayer-${{ steps.omar.outputs.run_id }}
    path: .sentinelayer/runs/${{ steps.omar.outputs.run_id }}
    if-no-files-found: warn
```

---

## Common Scenarios

### Gate blocked (exit `1`)

1. Read the PR comment (severity counts, top findings, codebase snapshot).
2. Open `REVIEW_BRIEF.md` for prioritized risk hotspots and suggested review order.
3. Open `AUDIT_REPORT.md` for full details on each finding.
4. Fix the findings and push a commit.
5. Re-run the workflow. If deduped, confirm the head SHA changed.

### Dedupe short-circuit

Dedupe means the same PR head SHA + idempotency inputs were already analyzed. The action mirrors the prior result.

- Verify the workflow is running on the latest commit SHA.
- To force re-analysis without code changes, change an idempotency input (`scan_mode`, `policy_pack_version`).

### Rate limited / cooldown

1. Check for repeated reruns (manual reruns, bot retriggers).
2. Adjust settings:

```yaml
with:
  min_scan_interval_minutes: 0
  max_daily_scans: 0
```

Rate limits are enforced via Check Run history. A new commit SHA resets counters.

### Fork blocked (exit `12`)

Root cause: `pull_request` workflows don't get secrets on fork PRs.

- Skip forks: `if: github.event.pull_request.head.repo.fork == false`
- For fork scanning, use `pull_request_target` with strict workflow hardening (see `docs/EXAMPLES.md`).

### Approval required (exit `13`)

Triggers: large diffs, high estimated cost, or rate-limit enforcement failure.

- Add the approval label (default: `sentinelayer:approved`), or
- Set `approval_mode: none` to disable cost confirmation.

### PR comment or Check Run missing

Required permissions:

```yaml
permissions:
  contents: read
  pull-requests: write
  checks: write
  id-token: write    # Required for OIDC telemetry (Tier 2+)
```

### Artifact integrity failure

1. Confirm `.sentinelayer/runs/<run_id>/PACK_SUMMARY.json` exists with `writer_complete: true`.
2. Confirm `FINDINGS.jsonl` SHA-256 matches the summary.
3. If missing, inspect earlier pipeline stages in job logs.

---

## Release Process

### Version Strategy

Omar Gate uses semantic versioning: `vMAJOR.MINOR.PATCH` (e.g., `v1.2.3`).

- **MAJOR:** Breaking changes to action inputs/outputs or gate behavior.
- **MINOR:** New features, new scan rules, new outputs.
- **PATCH:** Bug fixes, false positive reduction, dependency updates.

The `v1` floating tag always points to the latest `v1.x.x` release.

### Pre-Release Checklist

1. **All tests pass:** `python -m pytest tests/unit tests/integration -q` (currently 204 tests).
2. **Lint clean:** `ruff check src tests`
3. **Type check clean:** `mypy --follow-imports=skip --ignore-missing-imports src/omargate/analyze/llm/context_builder.py src/omargate/telemetry/uploader.py`
4. **Lockfile current:** `pip-compile --allow-unsafe --generate-hashes --output-file=requirements.lock.txt --strip-extras requirements.txt`
5. **Self-scan clean:** Run Omar Gate against its own repo; verify 0 P0/P1 blocking findings.
6. **Dependency audit:** `pip-audit -r requirements.txt` — no critical CVEs.
7. **Secret scan clean:** `gitleaks detect --source . --no-git` — 0 findings.
8. **Docker build succeeds:** `docker build -t omar-gate .`
9. **README badges updated:** Test count, version.
10. **RUNBOOK.md updated:** If pipeline or artifacts changed.

### Release Steps

```bash
# 1. Ensure main is up to date
git checkout main && git pull origin main

# 2. Update version in src/omargate/__init__.py
# 3. Update CHANGELOG (if maintained)

# 4. Commit, tag, and push
git add -A && git commit -m "release: v1.x.x"
git tag v1.x.x
git tag -f v1          # Move floating tag
git push origin main
git push origin v1.x.x
git push -f origin v1  # Force-update floating tag
```

### Post-Release Verification

1. Create a test PR in a consumer repo using `uses: mrrCarter/sentinelayer-v1-action@v1`.
2. Confirm the action runs, posts a PR comment, and uploads artifacts.
3. Confirm the codebase snapshot appears in the Step Summary.

---

## Dependency & Supply Chain Management

### Python Dependencies

| File | Purpose |
|---|---|
| `requirements.txt` | Direct dependencies with pinned versions |
| `requirements.lock.txt` | Full transitive closure with SHA-256 hashes (generated by `pip-compile`) |

**Updating dependencies:**

```bash
# Edit requirements.txt with new versions
pip-compile --allow-unsafe --generate-hashes \
  --output-file=requirements.lock.txt \
  --strip-extras requirements.txt

# Audit for vulnerabilities
pip-audit -r requirements.txt

# Run tests
PYTHONPATH=src python -m pytest tests/unit tests/integration -q
```

CI installs with `--require-hashes` so any tampering or hash mismatch fails the build deterministically.

### LLM CLI Dependencies

LLM CLIs are installed via npm in the `omar-review` job with pinned versions:

| CLI | Package | Purpose |
|---|---|---|
| `codex` | `@openai/codex` | Deep agentic code audit (primary) |
| `claude` | `@anthropic-ai/claude-code` | Anthropic provider support |
| `gemini` | `@google/gemini-cli` | Google provider support |

Versions are pinned in `security-review.yml` env vars and cached via `actions/cache@v4`.

### Docker Image

Multi-stage Alpine build. The builder stage installs Python deps; the runtime stage copies the prefix, source, and prompts. Codex CLI is installed at a pinned version via npm.

---

## LLM CLI Version Management

### Updating CLI Versions

1. Edit the version env vars at the top of the `omar-review` job in `security-review.yml`:

```yaml
env:
  CODEX_CLI_VERSION: "0.98.0"      # Update this
  CLAUDE_CLI_VERSION: "2.1.39"     # Update this
  GEMINI_CLI_VERSION: "0.28.0"     # Update this
```

2. Update the Codex CLI version in `Dockerfile`:

```dockerfile
RUN npm install -g @openai/codex@0.98.0
```

3. The npm cache key includes version strings, so bumping a version auto-invalidates the cache.

4. The `install_pinned_cli` function in the workflow checks for exact version match before reinstalling, making cached runs fast.

### Verifying CLIs

The "Verify LLM CLIs" step prints binary paths and versions. If a CLI fails to install, this step will fail the job before Omar Gate runs, preventing silent fallback.

---

## Secret Rotation

### Secrets Used by Omar Gate

| Secret | Scope | Where |
|---|---|---|
| `OPENAI_API_KEY` | OpenAI API + Codex CLI | Repo secret |
| `ANTHROPIC_API_KEY` | Anthropic API | Repo secret |
| `GOOGLE_API_KEY` | Google AI API | Repo secret |
| `XAI_API_KEY` | xAI API | Repo secret |
| `SENTINELAYER_TOKEN` | SentinelLayer dashboard (Tier 2+) | Repo secret |
| `github.token` | GitHub API (auto-provisioned) | Automatic |

### Rotation Procedure

1. Generate new key from the provider's dashboard.
2. Update the repo secret in GitHub Settings > Secrets and variables > Actions.
3. Trigger a workflow run to confirm the new key works.
4. Revoke the old key from the provider's dashboard.
5. Do **not** store API keys in environment variables, config files, or `.env` files committed to the repo.

### OIDC (Recommended for Tier 2+)

Instead of long-lived `SENTINELAYER_TOKEN`, use GitHub Actions OIDC:

```yaml
permissions:
  id-token: write
```

The action will automatically request an OIDC token and use it for telemetry uploads. No secret rotation needed for OIDC.

---

## False Positive Handling

Omar Gate uses a layered approach to minimize false positives:

### Layer 1: Deterministic Scanner Hardening

- **AST-based eval detection (Python):** Uses `ast.parse()` + `ast.walk()` instead of regex. Only flags actual `eval()`/`exec()` call nodes, not string literals containing "eval()".
- **JS/TS comment/string stripping:** Before regex matching, comments and string literals are blanked (preserving line offsets). Prevents flagging rule text or documentation inside strings.
- **Entropy false positive filtering:** Multi-stage pipeline:
  1. `_looks_like_non_secret_identifier()` — Skips SCREAMING_SNAKE, snake_case, paths (containing `/` or `.`), and low-variety tokens.
  2. `_likely_secret_context()` — Requires nearby secret-related keywords (`token`, `password`, `api_key`, `bearer`, etc.) unless the candidate has a known prefix (`ghp_`, `sk_live_`, `AKIA`, etc.).
  3. Strong entropy threshold — Candidates without secret context need entropy > 4.7 AND length >= 32 to be flagged (at P2 advisory level, not blocking).

### Layer 2: Harness Noise Reduction

- Historical entropy findings in git history are auto-downgraded to **P3 advisory** (non-blocking).
- Entropy findings in documentation files (`.md`, `.rst`, `.txt`) in git history are **dropped entirely**.
- Removed lines in diffs are flagged at P3 with low confidence for manual triage only.

### Layer 3: LLM Guardrails (Corroboration Requirement)

At [orchestrator.py:560](src/omargate/analyze/orchestrator.py#L560), `_apply_llm_guardrails()` enforces:

- **File validation:** LLM findings pointing to files not in the ingest are dropped.
- **Line clamping:** Line numbers are clamped to actual file bounds.
- **Corroboration requirement:** LLM/Codex P0/P1 findings require a deterministic or harness finding within 5 lines of the same file and category. Without corroboration, the finding is **downgraded to P2 advisory**.
- This prevents LLM hallucinations from blocking merges while preserving them as review hints.

### Gitleaks Allowlist

`.gitleaks.toml` excludes test fixtures and README examples:

```toml
[allowlist]
  paths = [
    '''tests/''',
    '''README\.md''',
  ]
```

### Handling Persistent False Positives

If a finding is a verified false positive:
1. Check if the deterministic scanner rule needs refinement (open an issue or PR).
2. For entropy findings, check if the candidate should be excluded by the identifier filter.
3. For LLM findings, they should already be downgraded to P2 by guardrails. If not, check corroboration logic.
4. Document the rationale in the PR and follow your exception workflow.

---

## Rollback Procedures

### Action Version Rollback

If a new release introduces regressions:

```bash
# Point the floating tag back to the previous release
git tag -f v1 v1.2.2   # Replace v1.2.2 with the last known good version
git push -f origin v1
```

Consumer repos using `@v1` will immediately pick up the rollback.

### Workflow Rollback

If a workflow change breaks CI:

```bash
# Revert the workflow commit
git revert <commit-sha>
git push origin main
```

### LLM Provider Fallback

If a Codex CLI update breaks the audit:

1. Set `INPUT_CODEX_ONLY: "false"` to re-enable API fallback.
2. Or downgrade the CLI version in `security-review.yml` env vars.
3. The npm cache will auto-invalidate on version change.

### Emergency: Disable Omar Gate

To unblock all PRs while debugging:

```yaml
# Option 1: Set severity gate to none
INPUT_SEVERITY_GATE: none

# Option 2: Skip the job
omar-review:
  if: false
```

---

## Monitoring & Observability

### What to Watch

| Signal | Source | Action |
|---|---|---|
| Omar Gate job duration | GitHub Actions logs | Investigate if > 120s for pr-diff or > 300s for deep |
| LLM cost per scan | `estimated_cost_usd` output | Alert if consistently > $1 for pr-diff |
| P0/P1 count trend | PR comments, `PACK_SUMMARY.json` | Investigate spikes; may indicate new code patterns or scanner regression |
| False positive ratio | Manual review of blocked PRs | If > 20% of blocking findings are FPs, tune scanners |
| Codex CLI failures | Job logs ("codex audit failed") | Check API key validity, model availability, CLI version |
| Gitleaks findings | `gitleaks-report.json` artifact | Investigate immediately; may indicate committed secrets |

### Debugging a Failed Run

1. Check the GitHub Actions job log for the failing step.
2. Look for the `run_id` in the Omar Gate step output.
3. Download artifacts: `gh run download <run-id> -n sentinelayer-<run-id>`
4. Read `PACK_SUMMARY.json` for counts and metadata.
5. Read `FINDINGS.jsonl` for individual findings with file paths and line numbers.
6. Check `CODEBASE_INGEST_SUMMARY.json` for what was scanned (file count, LOC, languages).

### Useful Commands

```bash
# View latest PR check results
gh pr checks <pr-number>

# Download run artifacts
gh run download <run-id>

# View workflow run logs
gh run view <run-id> --log

# Re-run failed jobs
gh run rerun <run-id> --failed
```

---

## Security & Privacy

- **LLM context:** A bounded code context is sent to your LLM provider using your own API key. Context size is controlled by `max_input_tokens` (default: 100,000).
- **Telemetry tiers:**
  - Tier 0: Off.
  - Tier 1: Aggregate counts only, anonymous, no auth required.
  - Tier 2: Metadata (repo identity + finding metadata), requires OIDC or JWT.
  - Tier 3: Full artifact upload, requires explicit opt-in.
- **OIDC for Tier 2+:** Use `id-token: write` permission. Never send Bearer tokens for Tier 1 (causes spurious 401s if OIDC verification fails server-side).
- **Fork PRs:** Treat as untrusted. Default `fork_policy: block` prevents running LLM analysis on fork PRs (which don't have access to secrets). Use `pull_request_target` only with strict workflow hardening.
- **Docker action:** Runs as non-root (`omar:1001`) inside the container. For host-runner execution (`python -m omargate.main`), the runner's own user context applies.
- **Secrets in findings:** All secrets in finding snippets are masked with `****` by `mask_secret_in_snippet()`.
- **Artifact integrity:** `PACK_SUMMARY.json` contains SHA-256 of `FINDINGS.jsonl`. Gate validates checksums before evaluating.

---

*Omar Gate v1 — Built by [PlexAura](https://plexaura.com) | [SentinelLayer](https://sentinelayer.com)*
