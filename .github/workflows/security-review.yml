name: Security Review
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest ruff

      - name: Lint
        run: ruff check src tests

      - name: Unit + Integration Tests
        run: python -m pytest tests/unit tests/integration -q

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          curl -sSLo gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.24.2/gitleaks_8.24.2_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: |
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path gitleaks-report.json \
            --redact \
            --no-git

      - name: Upload secret scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-${{ github.run_id }}
          path: gitleaks-report.json
          if-no-files-found: warn

  omar-review:
    name: Omar Review
    needs: [quality-gates, secret-scanning]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      checks: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install LLM CLIs
        run: |
          npm install -g @openai/codex@0.98.0
          npm install -g @anthropic-ai/claude-code || true
          npm install -g @google/gemini-cli || npm install -g @google-ai/gemini-cli || true

      - name: Verify LLM CLIs
        run: |
          codex --version || true
          claude --version || true
          gemini --version || true

      - name: Omar Gate
        id: omar
        uses: ./
        with:
          github_token: ${{ github.token }}
          llm_provider: ${{ vars.OMAR_LLM_PROVIDER || 'openai' }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          model: ${{ vars.OMAR_MODEL || 'gpt-4.1' }}
          model_fallback: ${{ vars.OMAR_MODEL_FALLBACK || 'gpt-4.1-mini' }}
          use_codex: true
          severity_gate: P1
          scan_mode: pr-diff

      - name: Upload Omar Gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sentinelayer-${{ steps.omar.outputs.run_id }}
          path: .sentinelayer/runs/${{ steps.omar.outputs.run_id }}
          if-no-files-found: warn
